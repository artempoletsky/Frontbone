/*! frontbone 2015-09-21 */
!function(a){"use strict";var b=function(){},c=function(){},d=/xyz/.test(function(){alert("xyz")})?/\b_super\b/:/.*/;c.prototype._constructor=Object,c.prototype.constructor=c,c.extend=function(a){"function"==typeof a&&(a={constructor:a});var c=this,e=function(){this._constructor.apply(this,arguments)};return a.hasOwnProperty("constructor")&&(a._constructor=a.constructor),b.prototype=c.prototype,e.prototype=new b,_.forOwn(a,function(a,b){e.prototype[b]="function"==typeof a&&void 0===a._notSimple&&d.test(a.toString())?function(){var d,e=this._super;return this._super=c.prototype[b],d=a.apply(this,arguments),this._super=e,d}:a}),e.prototype.constructor=e,e._notSimple=!0,e.extend=c.extend,e.create=c.create,e},c.create=function(a){var b,c,d,e=_.toArray(arguments),f=this.extend(a),g="return new child(",h=["child"],i=[f];if(e.shift(),b=e.length,b>0){for(c=0;b>c;c++)g+="arg"+c+", ",h.push("arg"+c),i.push(e[c]);g=g.substr(0,g.length-2)}g+=");",h.push(g);try{d=Function.apply(void 0,h).apply(void 0,i)}catch(j){throw j}return d},a.Class=c}(this),function(a){"use strict";Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){return _.indexOf(this,a,b)});var b=/\s+/,c=".",d=function(a,b,d,e){var f=a.split(c);return{c:d,s:e,fn:b,n:f[0],ns:f.slice(1)}},e=function(a,b){var c,d=!(a.fn&&a.fn!==b.fn||a.n&&a.n!==b.n||a.c&&a.c!==b.c);return d&&a.ns.length&&(c=b.ns,d=!_.any(a.ns,function(a){return c.indexOf(a)})),d},f=function(a,b,c,f,g){var h,i,j,k,l="any"===g?!1:[],m=d(b,c,f);if(g||(g="filter"),!a[m.n])return l;for(h=a[m.n],j=0,i=h.length;i>j;j++)if(k=h[j],e(m,k))if("filter"===g)l.push(k);else if("any"===g){l=!0;break}return l},g=function(a,b,c,f){var g,h;if(a._listeners){if(!b&&!c&&!f)return void delete a._listeners;if(g=d(b,c,f),!g.ns.length&&!c&&!f)return void delete a._listeners[g.n];if(!g.n||a._listeners[g.n]){var i={};g.n?i[g.n]=a._listeners[g.n]:i=a._listeners,_.each(i,function(a){for(h=0;h<a.length;h++)e(g,a[h])&&(a.splice(h,1),h--)})}}},h=Class.extend({on:function(a,c,e,f){var g,h,i,j,k,l,m,n,o=this;if(_.isObject(a)){g=c||o;for(k in a)o.on(k,a[k],g,f);return this}if("function"!=typeof c)throw TypeError("function expected");for(e||(e=this),h=a.split(b),i=0,j=h.length;j>i;i++)l=d(h[i],c,e,f),m=o._listeners||{},n=m[l.n]||[],n.push(l),m[l.n]=n,o._listeners=m;return o},off:function(a,c,d){var e,f,h,i=this;if(!a)return g(i,"",c,d),i;for(h=a.split(b),e=0,f=h.length;f>e;e++)g(i,h[e],c,d);return i},fire:function(a){if(!this._listeners)return this;var c,f,g,h,i,j,k,l=_.rest(arguments,1),m=this;for(g=a.split(b),c=0,f=g.length;f>c;c++){if(h=d(g[c],!1,!1),!h.n)throw"not implemented";if(i=m._listeners[h.n],!i)return m;for(j=0;j<i.length;j++)k=i[j],e(h,k)&&(k.s&&(i.splice(j,1),j--),k.fn.apply(k.c,l))}return m},one:function(a,b,c){return this.on(a,b,c,!0)},hasListener:function(a){return this._listeners?f(this._listeners,a,!1,!1,"any"):!1}});h.prototype.trigger=h.prototype.fire,a.Events=h}(this),function(a){"use strict";var b={},c=Events.extend({reverseComputedDeps:{},setComputeds:function(a){var b=this;_.each(a,function(a){var c=b._computeds[a].get();b.fire("change:"+a,c)})},addComputed:function(a,b){b.name=a,b.model=this,this._computeds[a]=new c.Computed(b)},removeComputed:function(a){var b=this;delete b._computeds[a],_.each(b.reverseComputedDeps,function(c,d){b.reverseComputedDeps[d]=_.without(c,a)})},constructor:function(a){var c=this;a=a||{},c.attributes=_.extend({},c.defaults,c.parse(a)),this.reverseComputedDeps={},this._computeds={},_.each(c.computeds,function(a,b){c.addComputed(b,a)}),c.useDefineProperty&&_.each(c.serialize(),function(a,b){Object.defineProperty(c,b,{get:function(){return this.prop(b)},set:function(a){this.prop(b,a)}})}),c._changed={},"id"==c.idAttribute&&c.useDefineProperty||(c.id=c.attributes[c.idAttribute]),c.cid=_.uniqueId("c"),c.mapping&&c.id&&(b[c.mapping]=b[c.mapping]||{},b[c.mapping][c.id]=c)},idAttribute:"id",mapping:!1,useDefineProperty:!0,computeds:{},_computeds:{},defaults:{},serialize:function(){return _.extend({},this.attributes,_.mapValues(this._computeds,function(a,b){return a.value}))},toJSON:function(){return this.serialize()},parse:function(a){return a},baseURL:"/",url:function(){return this.baseURL+(this.mapping?this.mapping+"/":"")+(this.id?this.id+"/":"")},update:function(a){return this.prop(this.parse(a)),this._changed={},this},prop:function(a,b){var c,d=this;if(1===arguments.length&&"string"==typeof a)return(c=d._computeds[a])?c.value:d.attributes[a];var e={},f={};return"string"==typeof a?e[a]=b:e=a,_.each(e,function(a,b){f[b]=d._changed[b]=a,(c=d._computeds[b])?c.set(a):d.attributes[b]=a,d.reverseComputedDeps[b]&&d.setComputeds(d.reverseComputedDeps[b]),b!==d.idAttribute||"id"==d.idAttribute&&d.useDefineProperty||(d.id=a),d.fire("change:"+b,a)}),this.fire("change",f),this},validate:function(){return!1},fetch:function(a){a=a||{};var b=this,d={success:function(c){b.update(c),"function"==typeof a.success&&a.success.apply(b,arguments)},error:function(){"function"==typeof a.error&&a.error.apply(b,arguments)}};return c.sync("get",this.url(),_.extend({},a,d)),this},save:function(a){var b,d=this,e=this.validate(a);if(e)return void this.trigger("invalid",this,e);if(b=_.isFunction(this.url)?this.url():this.url,a&&this.prop(a),this.id){if(0===_.keys(d._changed).length)return this;c.sync("update",b,{data:d._changed,success:function(a){d.update(a)}})}else c.sync("create",b,{data:d.serialize(),success:function(a){d.update(a)}});return this},remove:function(){this.fire("remove"),this.id&&c.sync("delete",this.url(),{})}});c.fromStorage=function(a,c){return b[a]=b[a]||{},b[a][c]},c.createOrUpdate=function(a,b){var d,e,f,g=a.prototype;return g.mapping&&(e=g.idAttribute,f=g.parse(b),d=c.fromStorage(g.mapping,f[e]))?(d.update(b),d):new a(b)},c.sync=function(a,b,c){c=c||{};var d={method:a};"PUT"===a&&(a="POST"),$.extend(d,c.data),$.ajax({url:b,dataType:"json",type:a,data:d,success:c.success,error:c.error})},c.filters={};var d=/\s*\|\s*/,e=/(\w+)(\s*:\s*['"]([^'"]+)['"])?/;c.hasFilters=function(a){return-1!=a.indexOf("|")},c.parseFilters=function(a){var b=a.split(d),c=b.shift();return{value:c,filters:_.foldl(b,function(a,b){var c=e.exec(b),d=c[3],f=c[1];return a[f]=d,a},{})}},c.Computed=Class.extend({constructor:function(a){this.deps=a.deps||[],this.name=a.name,this.model=a.model,this.filters=a.filters||{},a.filtersString&&this.parseFilters(a.filtersString),a.get&&(this.getter=a.get),a.set&&(this.setter=a.set),this.get();var b=this.model.reverseComputedDeps;_.each(this.deps,function(c){b[c]||(b[c]=[]),b[c].push(a.name)})},value:void 0,deps:[],model:void 0,filters:{},getter:function(a){return a},setter:function(a,b){this.prop(b,a)},parseFilters:function(a){var b=c.parseFilters(a);this.deps=[b.value],this.filters=b.filters},get:function(){var a=this,b=_.foldl(a.deps,function(b,c){return b.push(a.model.prop(c)),b},[]),d=a.getter.apply(a,b);return a.value=_.foldl(this.filters,function(a,b,d){return c.filters[d].format(a,b)},d),a.value},set:function(a){this.setter.call(this.model,_.foldl(this.filters,function(a,b,d){return c.filters[d].unformat(a,b)},a),this.name),this.get()}}),a.Model=c}(this),function(a){"use strict";var b=function(a){this.self=a},c=Model.extend({constructor:function(a,c){this._super(),this.itself=new b(this),this.models=[],this.length=0,a&&this.reset(a)},models:[],model:Model,url:function(){return this.baseURL+this.model.prototype.mapping+"/"},fetch:function(a){a=a||{};var b=this,c={success:function(c){b.reset(c,a),"function"==typeof a.success&&a.success.apply(b,arguments)},error:function(){"function"==typeof a.error&&a.error.apply(b,arguments)}},d=_.extend({},a,c);Model.sync("GET",this.url(),d)},reset:function(a,b){if(b=b||{},b.add||(this.fire("cut",this.models),this.models=[],this.length=0),!a)return this.fire("reset"),this;var c=this.parse(a);return this.add(c,"end"),b.add||this.fire("reset"),this},push:function(a){return this.add(a)},unshift:function(a){return this.add(a,0)},add:function(a,b,c){var d=this,e=[];return a instanceof Array||(a=[a]),"number"!=typeof b&&(b=this.length),_.each(a,function(a,c){a instanceof Model||(a=Model.createOrUpdate(d.model,a)),e.push(a),a.one("remove",function(){d.cutByCid(this.cid)}),d.models.splice(b+c,0,a)}),this.length=this.models.length,c||this.fire("add",e,b),this},cut:function(a){var b,c=this;return this.each(function(d,e){return d.id===a?(b=c.cutAt(e),!1):void 0}),b},cutByCid:function(a){var b,c=this;return this.each(function(d,e){return d.cid===a?(b=c.cutAt(e),!1):void 0}),b},shift:function(){return this.cutAt(0)},pop:function(){return this.cutAt()},cutAt:function(a){void 0===a&&(a=this.models.length-1);var b,c=this.models.splice(a,1)[0];return this.length=this.models.length,b={},b[a]=c,this.fire("cut",b),c},at:function(a){return this.models[a]},getByID:function(a){var b;return this.each(function(c){return c.id==a?(b=c,!1):void 0}),b},getByCid:function(a){var b;return this.each(function(c){return c.cid==a?(b=c,!1):void 0}),b}}),d=["detect","filter","select","reject","find","every","all","some","any","max","min","sortBy","sortByDesc","first","initial","rest","last","groupBy"],e=["forEach","each","map","reduce","reduceRight","foldl","foldr","include","contains","invoke","sortedIndex","toArray","size","without","indexOf","shuffle","lastIndexOf","isEmpty"],f=["filter","reject"],g=["sortBy","sortByDesc","shuffle"];_.mixin({sortByDesc:function(a,b,c){return this.sortBy(a,b,c).reverse()}});var h=function(a){return function(b){var c=!0;return _.forIn(a,function(a,d){return a!==b.attributes[d]?(c=!1,!1):void 0}),c}},i=function(a){return function(b){return b.attributes[a]}};_.each(e,function(a){c.prototype[a]=function(b,c){return _[a].apply(_,[this.models].concat(_.toArray(arguments)))}}),_.each(d,function(a){c.prototype[a]=function(b,c){if("function"==typeof b)return _[a].apply(_,[this.models].concat(_.toArray(arguments)));var d;if("string"==typeof b){if(2!=arguments.length)return _[a](this.models,i(b));d={},d[b]=c}return d||(d=b),_[a](this.models,h(d))}}),_.each(f,function(a){b.prototype[a]=function(){var b="filter"===a?"reject":"filter",c=this.self,d=(_.toArray(arguments),c[a].apply(c,arguments)),e=c[b].apply(c,arguments),f={};return _.each(e,function(a){f[c.indexOf(a)]=a}),c.models=d,c.length=d.length,c.fire("cut",f),c}}),_.each(g,function(a){b.prototype[a]=function(){var b=this.self,c=b[a].apply(b,arguments),d={};return _.each(c,function(a,c){d[c]=b.indexOf(a)}),b.models=c,b.length=c.length,b.fire("sort",d),b}}),a.Collection=c}(this),function(a){"use strict";var b,c=a.$,d=/\s+/,e=/^[a-z]+$/,f=/^\s*([^:]+)\s*:\s*([\s\S]*\S)\s*$/,g=/\s*,\s*/,h={shortcuts:{},setElement:function(a){return this.undelegateEvents(),this.el=a,this.$el=c(a),this.parseBinds().delegateEvents(),this},wrapReady:!1,$:function(a){return this.$el.find(a)},constructor:function(a){a=a||{};var b=this;b.options=a,a.collection&&(b.collection=a.collection),b.model=a.model,a.el&&(b.el=a.el),b._cid||(b._cid=_.uniqueId("vm")),b.el||(b.el="div"),b._super();var d=function(){"string"==typeof b.el&&(e.test(b.el)&&"html"!==b.el&&"body"!==b.el?b.el=document.createElement(b.el):b.el=c(b.el)[0]),b.$el=c(b.el),_.each(b.shortcuts,function(a,c){b[c]=b.$(a)}),b.autoParseBinds&&b.parseBinds(),b.delegateEvents(),b.initialize()};b.wrapReady?c(d):d()},remove:function(){return this.$el.remove(),this},parseBinds:function(){return h.findBinds(this.el,this),this},autoParseBinds:!1,initialize:function(){},delegateEvents:function(a){a=a||this.events,this.undelegateEvents();var b,c,e=this;return _.each(a,function(a,f){var g,h="function"==typeof a?a:e[a];if("function"!=typeof h)throw TypeError(a+" is not a function");b=f.split(d),c=b.shift().split(",").join("."+e._cid+" ")+"."+e._cid,g=_.bind(h,e),b.length?e.$el.delegate(b.join(" "),c,g):e.$el.bind(c,g)}),this},undelegateEvents:function(){return this.$el.unbind("."+this._cid),this},render:function(){return this}};h=Model.extend(h),h.findBinds=function(a,b){var d,e,f=!1,g=this,h=c(a),i=h[0];if(!i)throw new Error("Element not exists");return(e=g.tags[i.tagName.toLowerCase()])?void e.call(g,h,b):(_.forIn(_.foldl(i.attributes,function(a,b){return a[b.nodeName]=b.nodeValue,a},{}),function(a,c){var e=g.customAttributes[c];e&&(d=e.call(g,h,a,b),d===!1?f=!0:d&&(b=d))}),void(f||h.contents().each(function(){var a=this;3==this.nodeType?_.forIn(g.inlineModificators,function(c){c.call(g,a,b)}):1==this.nodeType&&g.findBinds(a,b)})))},b=function(a){var b={};return _.each(a.split(g),function(a){var c=f.exec(a);c&&(b[c[1]]=c[2])}),b},h.parseOptionsObject=function(a){var c,d={},e=0,f=function(a){a.match(/\{[^{}]*\}/)&&f(a.replace(/\{[^{}]*\}/,function(a){var c=Math.random()+e++;return d[c]=b(a.slice(1,-1)),c}))};if(f(a),_.each(d,function(a){_.each(a,function(b,c){d[b]&&(a[c]=d[b],delete d[b])})}),_.each(d,function(a){c=a}),!c)throw new Error(a+" is not valid options object");return c},a.ViewModel=h}(this),function(){"use strict";var a=function(a){return a||(0===a?"0":"")};ViewModel.replaceable=function(a,b,c){var d,e=function(a){d&&(d.off("replace",e),c(d)),b(a),a.on("replace",e),d=a};e(a)},ViewModel.applyFilters=function(a,b,c,d){var e;return ViewModel.replaceable(b,function(b){Model.hasFilters(a)?(e=_.uniqueId("vmDynamicComputed"),b.addComputed(e,{filtersString:a})):e=a,b.on("change:"+e,c),c(b.prop(e))},function(b){Model.hasFilters(a)&&b.removeComputed(e),b.off("change:"+e,c),d&&d(b.prop(e))}),e},ViewModel.binds={log:function(a,b,c){this.applyFilters(b,c,function(a){console.log(c,".",b,"=",a)})},src:function(a,b,c,d){var e=a[0];this.findCallAndSubscribe(b,c,d,function(a){e.src=a||""},a)},html:function(b,c,d){this.applyFilters(c,d,function(c){b.html(a(c))})},text:function(b,c,d){this.applyFilters(c,d,function(c){b.text(a(c))})},value:function(b,c,d){var e=this.applyFilters(c,d,function(c){b.val(a(c))});b.on("change keyup keydown",function(){var a=b.val();d.prop(e,a)})},attr:function(a,b,c){var d=a[0];_.each(this.parseOptionsObject(b),function(a,b){ViewModel.applyFilters(a,c,function(a){a!==!1&&void 0!==a&&null!==a?d.setAttribute(b,a):d.removeAttribute(b)})})},style:function(a,b,c){_.each(this.parseOptionsObject(b),function(b,d){ViewModel.applyFilters(b,c,function(b){a.css(d,b)})})},css:function(a,b,c,d){_.each(this.parseOptionsObject(b),function(b,d){ViewModel.applyFilters(b,c,function(b){b?a.addClass(d):a.removeClass(d)})})},display:function(a,b,c){ViewModel.applyFilters(b,c,function(b){b?a.show():a.hide()})},click:function(a,b,c,d){var e=this.evil(b,c,d,a)();a.click(function(){e.apply(c,arguments)})},className:function(a,b,c){var d;ViewModel.applyFilters(b,c,function(b){d&&a.removeClass(d),b&&a.addClass(b),d=b})},events:function(a,b,c,d){var e=this;_.each(this.parseOptionsObject(b),function(b,f){var g=e.evil(b,c,d)();a.bind(f,function(a){g.call(c,a)})})},view:function(a,b,c,d){var e,f,g,h,i;try{e=this.parseOptionsObject(b)}catch(j){i=b.split(/\s*,\s*/),e={"class":i[0],name:i[1]}}return f=e["class"]?this.evil(e["class"],c,d)():ViewModel.extend({autoParseBinds:!0}),g={el:a},e.options&&_.forOwn(e.options,function(a,b){g[b]=ViewModel.evil(a,c,d)()}),h=new f(g),e.name&&(c[e.name]=h),!1},$click:function(a,b,c,d){return a.click(this.evil(b,c,d)),!1}};var b=/\s*;\s*/,c=/^\s*([^:]+)\s*:\s*([\s\S]*\S)\s*$/,d=/\s*,\s*/,e=function(a,e,f,g,h){e.removeAttr(a);var i,j;return f&&_.each(f.split(b),function(a){var b,f,k,l=a.match(c);l?(b=l[1],f=l[2]):(b=a,f=""),b=b.split(d),_.each(b,function(a){a&&"!"!==a.charAt(0)&&(k=ViewModel.binds[a],k?(i=k.call(ViewModel,e,f,g,h),i===!1?j=!0:i&&(g=i)):console.warn('Bind: "'+a+'" not exists'))})}),j?!1:g};ViewModel.tag=function(a,b){document.createElement(a),ViewModel.tags[a]=b},ViewModel.removeTag=function(a){delete ViewModel.tags[a]},ViewModel.tags={},ViewModel.customAttributes={"data-bind":function(a,b,c,d){return e("data-bind",a,b,c,d)},nk:function(a,b,c,d){return e("nk",a,b,c,d)}},Model.filters._sysEmpty={format:a},ViewModel.inlineModificators={"{{}}":function(a,b){var c,d,e,f=a.nodeValue,g=[a],h=ViewModel.inlineModificators["{{}}"].regex;if(h.lastIndex=0,h.test(f)){var i=f.split(h),j=[],k="return ";_.each(i,function(a,b){if(b%2){a+=" | _sysEmpty";var c=Model.parseFilters(a);a=_.foldl(c.filters,function(a,b,c){var d="";return void 0!==b&&(d=', "'+b+'"'),"Model.filters."+c+".format("+a+d+")"},c.value),j.push(c.value),k+=a+"+"}else k+='"'+a+'"+'}),k+='"";',k=k.replace(/\n/g,"\\n\\\n"),c=a.parentNode,e=document.createElement("div");var l,m=1===c.childNodes.length?function(a){try{c.innerHTML=a}catch(b){console.log(b)}}:function(a){d=document.createDocumentFragment();try{e.innerHTML=a}catch(b){console.log(b)}var f,h=_.toArray(e.childNodes);for(f=g[0];g[1];)c.removeChild(g[1]),g.splice(1,1);if(!h.length)return f.nodeValue="",void(g=[f]);for(;e.childNodes[0];)d.appendChild(e.childNodes[0]);if(d.childNodes.length)try{c.insertBefore(d,f)}catch(i){throw i}c.removeChild(f),g=h};ViewModel.replaceable(b,function(a){l=_.uniqueId("vmDynamicComputed");try{var b=new Function(j.join(","),k)}catch(c){console.log(c),console.log(k)}a.addComputed(l,{deps:j,get:b}),a.on("change:"+l,m),m(a.prop(l))},function(a){a.removeComputed(l),a.off("change:"+l,m)})}}},ViewModel.inlineModificators["{{}}"].regex=/\{\{([\s\S]+?)\}\}/g}(),function(){"use strict";var a={},b={};ViewModel.tmpl={setRawTemplate:function(b,c){a[b]=c},getRawTemplate:function(b){return a[b]},get:function(c,d){var e,f=b[c];if(!f){if(e=a[c],void 0===e)throw new Error('Raw template: "'+c+'" is not defined');b[c]=f=d(e)}return f}},ViewModel.binds.template=function(c,d,e,f){var g=$(c),h=d.split(/\s*,\s*/),i=h[0],j=h[1];return a[i]=g.html(),g.remove(),j&&(j=this.evil(j,e,f),b[i]=j(a[i])),!1}}(),function(){"use strict";ViewModel.binds.withModel=function(a,b,c){var d;return this.applyFilters(b,c,function(a){d&&d.fire("replace",a),d=a}),d};var a={},b=function(a,b,c){return!1};setInterval(function(){_.each(a,function(b,c){_.each(b,function(a){a.clearBinds(),a.data("nkModel","")}),a[c]=[]})},3e5),ViewModel.binds.eachModel=function(c,d,e){var f,g,h,i,j,k=c[0],l={},m=k.tagName.toLowerCase();return f=d.split(/\s*,\s*/),g=f[0],h=f[1],i=h?"":c.html(),j=h?h:_.uniqueId("nkEachModelTemplate"),a[j]=[],this.applyFilters(g,e,function(d){c.empty();var e,f,g;if(d){e=1,f=function(a){var c=$(a);return function(a,d,f){var g=b(j,a,d);return g||(g=c.clone(),g.each(function(){ViewModel.findBinds(this,a)})),e=g.length,g}},g=h?ViewModel.tmpl.get(h,f):f(i);var k=$(document.createElement(m)),n=0;c.empty(),d.each(function(a){k.append(g(a,n++,d))}),c.append(k.children()),d.on("add",function(a,b,f){var h=0,i="",j=f||b;i=$(document.createElement(m)),_.each(a,function(a){i.append(g(a,j+h++,d))}),i=i.children(),0===b?c.prepend(i):b&&b!==d.length-a.length?c.children().eq(b*e).before(i):c.append(i)},l),d.on("cut",function(b){var d,f,g,h=c.children();for(d in b)d*=1,f=b[d],f.off(0,0,l),g=h.slice(d,d+e),a[j].push(g),g.detach()},l),d.on("sort",function(a){var b=$(document.createElement(m)),d=c.children();_.each(a,function(a,c){b.append(d.slice(a,a+e))}),c.append(b.children())},l)}},function(a){a.off(0,0,l),a.each(function(a){a.off(0,0,l)})}),!1}}(),function(a){"use strict";var b=/\((.*?)\)/g,c=/(\(\?)?:\w+/g,d=/\*\w+/g,e=/[\-{}\[\]+?.,\\\^$|#\s]/g;a.Router=Events.extend({constructor:function(a){a||(a={}),a.routes&&(this.routes=a.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},initialize:function(){},route:function(b,c,d){_.isRegExp(b)||(b=this._routeToRegExp(b)),_.isFunction(c)&&(d=c,c=""),d||(d=this[c]);var e=this;return a.History.route(b,function(f){var g=e._extractParameters(b,f);d&&d.apply(e,g),e.trigger.apply(e,["route:"+c].concat(g)),e.trigger("route",c,g),a.History.trigger("route",e,c,g)}),this},navigate:function(b,c){return a.History.navigate(b,c),this},_bindRoutes:function(){if(this.routes){this.routes=_.result(this,"routes");for(var a,b=_.keys(this.routes);null!=(a=b.pop());)this.route(a,this.routes[a])}},_routeToRegExp:function(a){return a=a.replace(e,"\\$&").replace(b,"(?:$1)?").replace(c,function(a,b){return b?a:"([^/]+)"}).replace(d,"(.*?)"),new RegExp("^"+a+"$")},_extractParameters:function(a,b){var c=a.exec(b).slice(1);return _.map(c,function(a){return a?decodeURIComponent(a):null})}})}(this),function(a){"use strict";var b=/^[#\/]|\s+$/g,c=/^\/+|\/+$/g,d=/msie [\w.]+/,e=/\/$/,f=Events.extend({interval:50,started:!1,constructor:function(){this.handlers=[],_.bindAll(this,"checkUrl"),"undefined"!=typeof a&&(this.location=a.location,this.history=a.history)},getHash:function(a){var b=(a||this).location.href.match(/#(.*)$/);return b?b[1]:""},getFragment:function(a,c){if(null==a)if(this._hasPushState||!this._wantsHashChange||c){a=this.location.pathname;var d=this.root.replace(e,"");a.indexOf(d)||(a=a.slice(d.length))}else a=this.getHash();return a.replace(b,"")},start:function(e){if(this.started)throw new Error("Backbone.history has already been started");this.started=!0,this.options=_.extend({},{root:"/"},this.options,e),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var f=this.getFragment(),g=document.documentMode,h=d.exec(navigator.userAgent.toLowerCase())&&(!g||7>=g);this.root=("/"+this.root+"/").replace(c,"/"),h&&this._wantsHashChange&&(this.iframe=$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(f)),this._hasPushState?$(a).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in a&&!h?$(a).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=f;var i=this.location,j=i.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!j)return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0;this._hasPushState&&j&&i.hash&&(this.fragment=this.getHash().replace(b,""),this.history.replaceState({},document.title,this.root+this.fragment+i.search))}return this.options.silent?void 0:this.loadUrl()},stop:function(){$(a).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),this.started=!1},route:function(a,b){this.handlers.unshift({route:a,callback:b})},checkUrl:function(a){var b=this.getFragment();return b===this.fragment&&this.iframe&&(b=this.getFragment(this.getHash(this.iframe))),b===this.fragment?!1:(this.iframe&&this.navigate(b),void this.loadUrl())},loadUrl:function(a){var b=this.fragment=this.getFragment(a);return _.any(this.handlers,function(a){return a.route.test(b)?(a.callback(b),!0):void 0})},navigate:function(a,b){if(!this.started)return!1;if(b&&b!==!0||(b={trigger:!!b}),a=this.getFragment(a||""),this.fragment!==a){this.fragment=a;var c=this.root+a;if(""===a&&"/"!==c&&(c=c.slice(0,-1)),this._hasPushState)this.history[b.replace?"replaceState":"pushState"]({},document.title,c);else{if(!this._wantsHashChange)return this.location.assign(c);this._updateHash(this.location,a,b.replace),this.iframe&&a!==this.getFragment(this.getHash(this.iframe))&&(b.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,a,b.replace))}return b.trigger?this.loadUrl(a):void 0}},_updateHash:function(a,b,c){if(c){var d=a.href.replace(/(javascript:|#).*$/,"");a.replace(d+"#"+b)}else a.hash="#"+b}});a.History=new f}(this);