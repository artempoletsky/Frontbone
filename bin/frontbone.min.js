/*! frontbone 2013-03-09 */
(function(t){"use strict";var e,n,i,r=[],s=!1,o=!1,u=t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||t.msRequestAnimationFrame||t.oRequestAnimationFrame||function(t){setTimeout(function(){t()},1e3/15)},c=function(t){-1===r.indexOf(t)&&r.push(t)},a=t.ComputedRefresher={refreshAll:function(){_.each(r,function(t){t.notify()}),r=[]},startRefresh:function(){var t=this;s=!0,u(function(){s&&(t.refreshAll(),t.startRefresh())})},stopRefresh:function(){s=!1}};a.startRefresh(),i=function(t){t=t||{};var e=t.initial,n=e,i=t.get,r=t.set,s=t.context,u=t.async,a=[],f=[],h=function(t){if(0===arguments.length)i?e=i.call(s):o&&o.dependsOn(h);else if(e!==t||_.isObject(t)){if(r)r.call(s,t);else{if(i)throw Error("Setter for computed is not defined");e=t}u?c(h):h.notify()}return e};return _.extend(h,{dependsOn:function(t){var e=this;return-1===a.indexOf(t)&&(a.push(t),t.subscribe(function(){u?c(h):h.notify()})),e},subscribe:function(t){return f.push(t),this},unsubscribe:function(t){return f=_.filter(f,function(e){return e===t}),this},notify:function(){var t=this,e=t();return(n!==e||_.isObject(e))&&_.each(f,function(n){n.call(t,e)}),n=e,t},callAndSubscribe:function(t){return t.call(this,this()),this.subscribe(t),this},_notSimple:!0,__observable:!0}),h.fire=h.notify,h.valueOf=h.toString=function(){return this()},i&&(o=h,e=n=i.call(s),o=!1),delete h.dependsOn,a=void 0,h},e=function(t){return i({initial:t})},e.isObservable=function(t){return"function"!=typeof t?!1:t.__observable||!1},n=function(t,e,n,r){return i("function"==typeof t?{get:t,context:e,set:r,async:n}:t)},t.BaseObservable=i,t.Observable=e,t.Computed=n})(this),function(t){"use strict";var e=function(){},n=function(){},i=/xyz/.test(function(){alert("xyz")})?/\b_super\b/:/.*/;n.prototype._constructor=Object,n.prototype.constructor=n,n.extend=function(t){var n=this,r=function(){this._constructor.apply(this,arguments)};return t.hasOwnProperty("constructor")&&(t._constructor=t.constructor),e.prototype=n.prototype,r.prototype=new e,_.each(t,function(t,e){r.prototype[e]="function"==typeof t&&void 0===t._notSimple&&i.test(""+t)?function(){var i,r=this._super;return this._super=n.prototype[e],i=t.apply(this,arguments),this._super=r,i}:t}),r.prototype.constructor=r,r._notSimple=!0,r.extend=n.extend,r.create=n.create,r},n.create=function(t){var e,n,i,r=_.toArray(arguments),s=this.extend(t),o="return new child(",u=["child"],c=[s];if(r.shift(),e=r.length,e>0){for(n=0;e>n;n++)o+="arg"+n+", ",u.push("arg"+n),c.push(r[n]);o=o.substr(0,o.length-2)}o+=");",u.push(o);try{i=Function.apply(void 0,u).apply(void 0,c)}catch(a){throw a}return i},t.Class=n}(this),function(t){"use strict";Array.prototype.indexOf||(Array.prototype.indexOf=function(t,e){return _.indexOf(this,t,e)});var e=/\s+/,n=".",i=function(t,e,i,r){t+="";var s=t.split(n);return{c:i,s:r,fn:e,n:s[0],ns:s.slice(1),o:t}},r=function(t,e){var n,i;n=t._listeners||{},i=n[e.n]||[],i.push(e),n[e.n]=i,t._listeners=n},s=function(t,e,n,r,s){var o="any"===s?!1:[],u=i(e,n,r);return s||(s="filter"),_.each(t,function(t){return _.each(t,function(t){var e,n=!(u.fn&&u.fn!==t.fn||u.n&&u.n!==t.n||u.c&&u.c!==t.c);if(n&&u.ns.length&&(e=t.ns,n=!_.any(u.ns,function(t){return e.indexOf(t)})),n){if("filter"===s)o.push(t);else if("any"===s)return o=!0,!1}else"invert"===s&&o.push(t)}),o===!0?!1:void 0}),o},o=function(t,e,n,o){var u,c,a;if(t._listeners){if(!e&&!n&&!o)return delete t._listeners,void 0;if(u=i(e,n,o),!u.ns.length&&!n&&!o)return delete t._listeners[u.n],void 0;for(c=s(t._listeners,e,n,o,"invert"),delete t._listeners,a=c.length-1;a>=0;a--)r(t,c[a])}},u=Class.extend({on:function(t,n,s,o){var u,c=this;if(_.isObject(t))return u=n||c,_.each(t,function(t,e){c.on(e,t,u,o)}),this;if("function"!=typeof n)throw TypeError("function expected");return s||(s=this),_.each(t.split(e),function(t){r(c,i(t,n,s,o))}),c},off:function(t,n,i){var r=this;return t?(_.each(t.split(e),function(t){o(r,t,n,i)}),r):(o(r,"",n,i),r)},fire:function(t){if(!this._listeners)return this;var n=_.rest(arguments,1),i=this;return _.each(t.split(e),function(t){_.each(s(i._listeners,t,!1,!1),function(t){t.s&&i.off(0,t.fn),t.fn.apply(t.c,n)})}),i},one:function(t,e,n){return this.on(t,e,n,!0)},hasListener:function(t){return this._listeners?s(this._listeners,t,!1,!1,"any"):!1}});u.prototype.trigger=u.prototype.fire,t.Events=u}(this),function(t){"use strict";var e={},n=Events.extend({constructor:function(t){t=t||{},this.attributes=_.extend({},this.defaults,this.parse(t)),this._changed={},this.id=this.attributes[this.idAttribute],this.cid=_.uniqueId("c"),this.mapping&&this.id&&(e[this.mapping]=e[this.mapping]||{},e[this.mapping][this.id]=this),this.initialize()},initialize:function(){return this},idAttribute:"id",mapping:!1,defaults:{},toJSON:function(){return _.clone(this.attributes)},parse:function(t){return t},baseURL:"/",url:function(){return this.baseURL+(this.mapping?this.mapping+"/":"")+(this.id?this.id+"/":"")},update:function(t){return this.prop(this.parse(t)),this._changed={},this},prop:function(t,e){if(1===arguments.length&&"string"==typeof t)return this.attributes[t];var n={},i=this,r={};return"string"==typeof t?n[t]=e:n=t,_.each(n,function(t,e){r[e]=i._changed[e]=i.attributes[e]=t,e===i.idAttribute&&(i.id=t),i.fire("change:"+e)}),this.fire("change",r),this},get:function(){return this.prop.apply(this,arguments)},set:function(){return this.prop.apply(this,arguments)},validate:function(){return!0},fetch:function(t){t=t||{};var e=this,i={success:function(n){e.update(n),"function"==typeof t.success&&t.success.apply(e,arguments)},error:function(){"function"==typeof t.error&&t.error.apply(e,arguments)}};return n.sync("read",this.url(),_.extend({},t,i)),this},save:function(){var t=this;if(!this.validate())throw Error("Model is invalid");if(this.id){if(0===_.keys(t._changed).length)return this;n.sync("update",this.url(),{data:t._changed,success:function(e){t.update(e)}})}else n.sync("create",this.url(),{data:_.clone(this.attributes),success:function(e){t.update(e)}});return this},remove:function(){this.fire("remove"),this.id&&n.sync("delete",this.url(),{})}});n.fromStorage=function(t,n){return e[t]=e[t]||{},e[t][n]},n.createOrUpdate=function(t,e){var i,r,s,o=t.prototype;return o.mapping&&(r=o.idAttribute,s=o.parse(e),i=n.fromStorage(o.mapping,s[r]))?(i.update(e),i):new t(e)},n.sync=function(t,e,n){n=n||{};var i={method:t};"PUT"===t&&(t="POST"),$.extend(i,n.data),$.ajax({url:e,dataType:"json",type:t,data:i,success:n.success,error:n.error})},t.Model=n}(this),function(){"use strict";var t=function(t){this.self=t},e=Model.extend({constructor:function(e,n){this.itself=new t(this),this.models=[],this.length=0,this._hashId=[],e&&this.reset(e),this.initialize(n)},models:[],model:Model,url:function(){return this.baseURL+this.model.prototype.mapping+"/"},fetch:function(t){t=t||{};var e=this;return Model.sync("GET",this.url(),_.defaults(t,{success:function(n){e.reset(n,t),"function"==typeof t.success&&t.success.apply(e,arguments)},error:function(){"function"==typeof t.error&&t.error.apply(e,arguments)}})),e},reset:function(t,e){if(e=e||{},e.add||(this.fire("beforeReset",this.models),this.models=[],this.length=0,this._hashId=[]),!t)return this.fire("reset"),this;var n=this.parse(t);return this.add(n,"end",!e.add),e.add||this.fire("reset"),this},push:function(t){return this.add(t)},unshift:function(t){return this.add(t,0)},add:function(t,e,n){function i(t,e){if(0===e&&o.length)r=o._hashId[0].index-1,o._hashId.unshift({id:t.id,index:r});else{var n=o._hashId.length;r=0===n?1:o._hashId[n-1].index+1,o._hashId.push({id:t.id,index:r})}}var r,s,o=this,u=[];return t instanceof Array||(t=[t]),"number"!=typeof e?e=this.length:0===e&&(s=t.reverse()),_.each(t,function(t,n){t instanceof Model||(t=Model.createOrUpdate(o.model,t)),u.push(t),s?i(s[n],0):i(t,e+n),t.one("remove",function(){o.cutByCid(this.cid)}),o.models.splice(e+n,0,t)}),this.length=this.models.length,n||this.fire("add",u,e),this},cut:function(t){var e,n=this;return n.each(function(i,r){return i.id===t?(e=n.cutAt(r),!1):void 0}),e},cutByCid:function(t){var e,n=this;return this.each(function(i,r){return i.cid===t?(e=n.cutAt(r),!1):void 0}),e},shift:function(){return this.cutAt(0)},pop:function(){return this.cutAt()},cutAt:function(t){void 0===t&&(t=this.models.length-1);var e,n=this.models.splice(t,1)[0];return this._hashId.splice(t,1),this.length=this.models.length,e={},e[t]=n,this.fire("cut",e),n},at:function(t){return this.models[t]},get:function(){return this.getByID.apply(this,arguments)},getByID:function(t){return this.find(function(e){return e.id===t})},getByCid:function(t){return this.find(function(e){return e.cid===t})},getIndex:function(t){var e=this.indexOf(t);return this._hashId[e].index}}),n=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortByDesc","sortedIndex","toArray","size","first","initial","rest","last","without","indexOf","shuffle","lastIndexOf","isEmpty","groupBy"],i=["filter","reject"],r=["sortBy","sortByDesc","shuffle"],s=function(t){return _.isFunction(t)?t:function(e){return e[t]}};_.sortByDesc=function(t,e,n){var i=s(e);return _.pluck(_.map(t,function(t,e,r){return{value:t,index:e,criteria:i.call(n,t,e,r)}}).sort(function(t,e){var n=t.criteria,i=e.criteria;if(n!==i){if(n>i||void 0===n)return-1;if(i>n||void 0===i)return 1}return t.index<e.index?-1:1}),"value")},_.each(n,function(t){e.prototype[t]=function(){return _[t].apply(_,[this.models].concat(_.toArray(arguments)))}}),_.each(i,function(e){t.prototype[e]=function(){var t="filter"===e?"reject":"filter",n=this.self,i=_.toArray(arguments),r=_[e].apply(_,[n.models].concat(i)),s=_[t].apply(_,[n.models].concat(i)),o={};return _.each(s,function(t){o[n.indexOf(t)]=t}),n.models=r,n.length=r.length,n.fire("cut",o),n}}),_.each(r,function(e){t.prototype[e]=function(){var t=this.self,n=_[e].apply(_,[t.models].concat(_.toArray(arguments))),i={};return _.each(n,function(e,n){i[t.indexOf(e)]=n}),t.models=n,t.length=n.length,t.fire("sort",i),t}}),window.Collection=e}(this),function(t){"use strict";var e=t.$,n=/\s+/,i=/\s*;\s*/,r=/^[a-z]+$/,s=/^\s*([^:]+)\s*:\s*([\s\S]*\S)\s*$/,o=/^\{([\s\S]*)\}$/,u=/\s*,\s*/,c={setElement:function(t){return this.undelegateEvents(),this.el=t,this.$el=e(t),this.parse().delegateEvents(),this},constructor:function(t){t=t||{},this.options=t,t.collection&&(this.collection=t.collection),this.model=t.model,t.el&&(this.el=t.el);var n=this;n._cid||(n._cid=_.uniqueId("vm")),n.el||(n.el="div"),"string"==typeof n.el&&(n.el=r.test(n.el)&&"html"!==n.el&&"body"!==n.el?document.createElement(n.el):e(n.el)[0]),n.$el=e(n.el),n.$=function(t){return n.$el.find(t)},n.initialize(),n.autoParseBinds&&n.parse(),n.delegateEvents()},remove:function(){return this.$el.remove(),this},parse:function(){return c.findBinds(this.el,this),this},bindToModel:function(t){var e=Observable(new Model(t)),n=e(),i={},r=this;return e.callAndSubscribe(function(t){n&&n.off(0,0,i),n=t,t&&t.on("change",function(t){_.each(t,function(t,e){r[e].fire()})},i)}),this._bindedToModel||_.each(n.attributes,function(t,n){r[n]=Computed(function(){var t=e();return t?t.prop(n):""})}),this._bindedToModel=!0,e},autoParseBinds:!1,initialize:function(){},delegateEvents:function(t){t=t||this.events,this.undelegateEvents();var e,i,r=this;return _.each(t,function(t,s){var o,u="function"==typeof t?t:r[t];if("function"!=typeof u)throw TypeError(t+" is not a function");e=s.split(n),i=e.shift().split(",").join("."+r._cid+" ")+"."+r._cid,o=_.bind(u,r),e.length?r.$el.delegate(e.join(" "),i,o):r.$el.bind(i,o)}),this},undelegateEvents:function(){return this.$el.unbind("."+this._cid),this},render:function(){return this}};c=Events.extend(c),c.compAsync=!0,c.findObservable=function(t,e,n){n=n||{},Observable.isObservable(t)&&(t=t());var i,r,s,o,u=[],c=[];return _.each(n,function(t,e){u.push(e),c.push(t)}),u.push("with(this) return "+e),i=Function.apply(t,u),s=function(){try{return i.apply(t,c)}catch(n){console.log('Error "'+n.message+'" in expression "'+e+'" Context: ',t)}},o=s(),this.compAsync?(Observable.isObservable(o)||(o=s),r=BaseObservable({async:!0,get:function(){return o()},set:function(t){o(t)}})):r=Observable.isObservable(o)?o:Computed(function(){return s()},t),r},c.findBinds=function(t,n,r){var o,a,f,h,l,d,p,v,b,m,y,_,g,O=!1,x=this,A=e(t);if(o=A.attr("data-bind"),A.removeAttr("data-bind"),o)for(a=o.split(i),f=0,p=a.length;p>f;f++)for(v=a[f],g=v.match(s),g?(m=g[1],y=g[2]):(m=v,y=""),m=m.split(u),h=0,l=m.length;l>h;h++)b=m[h],b&&"!"!==b.charAt(0)&&(_=c.binds[b],_?(d=_.call(x,t,y,n,r),d===!1?O=!0:d&&(n=d)):console.warn('Bind: "'+b+'" not exists'));O||A.children().each(function(){x.findBinds(this,n,r)})},c.parseOptionsObject=function(t){var e,n,i;if(!t)return{};if(e=t.match(o),!e||void 0===e[1])throw Error('Expression: "'+t+'" is not valid object');return n=e[1].split(u),n.length?(i={},_.each(n,function(n){if(n){if(e=n.match(s),!e||!e[1]||!e[2])throw Error('Expression: "'+t+'" is not valid object');i[e[1]]=e[2]}}),i):{}},t.ViewModel=c}(this),function(){"use strict";ViewModel.binds={log:function(t,e,n,i){this.findObservable(n,e,i).callAndSubscribe(function(){console.log(n,".",e,"=",this())})},src:function(t,e,n,i){this.findObservable(n,e,i).callAndSubscribe(function(e){t.src=e||""})},html:function(t,e,n,i){this.findObservable(n,e,i).callAndSubscribe(function(e){t.innerHTML=e})},text:function(t,e,n,i){var r=$(t);this.findObservable(n,e,i).callAndSubscribe(function(t){r.text(t)})},"with":function(t,e,n,i){return this.findObservable(n,e,i)()},each:function(t,e,n,i){var r=this.findObservable(n,e,i),s=$(t),o=s.html();return s.empty(),i=i?_.clone(i):{},r.callAndSubscribe(function(t){s.empty(),t&&_.each(t,function(e,n){i.$index=n,i.$parent=t,i.$value=e;var r=document.createElement("div");r.innerHTML=o,ViewModel.findBinds(r,e,i),s.append(r.innerHTML)})}),!1},value:function(t,e,n,i){var r=$(t),s=this.findObservable(n,e,i).callAndSubscribe(function(t){r.val(t)});r.change(function(){s(r.val())})},attr:function(t,e,n,i){_.each(this.parseOptionsObject(e),function(e,r){ViewModel.findObservable(n,e,i).callAndSubscribe(function(e){e?t.setAttribute(r,e):t.removeAttribute(r)})})},style:function(t,e,n,i){var r=$(t);_.each(this.parseOptionsObject(e),function(t,e){ViewModel.findObservable(n,t,i).callAndSubscribe(function(t){r.css(e,t)})})},css:function(t,e,n,i){var r=$(t);_.each(this.parseOptionsObject(e),function(t,e){ViewModel.findObservable(n,t,i).callAndSubscribe(function(t){t?r.addClass(e):r.removeClass(e)})})},display:function(t,e,n,i){var r=$(t);this.findObservable(n,e,i).callAndSubscribe(function(t){t?r.show():r.hide()})},click:function(t,e,n,i){var r=this.findObservable(n,e,i)(),s=$(t);s.click(function(){r.apply(n,arguments)})}}}(),function(){"use strict";var t={},e={};ViewModel.tmpl={getRawTemplate:function(e){return t[e]},get:function(n,i){var r,s=e[n];if(!s){if(r=t[n],!r)throw Error('Raw tempalte: "'+n+'" is not defined');e[n]=s=i(r)}return s}},ViewModel.binds.template=function(e,n){var i=$(e);return t[n]=i.html(),i.remove(),!1}}();