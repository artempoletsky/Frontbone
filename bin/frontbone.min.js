/*! frontbone 2015-08-04 */
(function(t){"use strict";var e=function(){},n=function(){},i=/xyz/.test(function(){alert("xyz")})?/\b_super\b/:/.*/;n.prototype._constructor=Object,n.prototype.constructor=n,n.extend=function(t){"function"==typeof t&&(t={constructor:t});var n=this,r=function(){this._constructor.apply(this,arguments)};return t.hasOwnProperty("constructor")&&(t._constructor=t.constructor),e.prototype=n.prototype,r.prototype=new e,_.forOwn(t,function(t,e){r.prototype[e]="function"==typeof t&&void 0===t._notSimple&&i.test(""+t)?function(){var i,r=this._super;return this._super=n.prototype[e],i=t.apply(this,arguments),this._super=r,i}:t}),r.prototype.constructor=r,r._notSimple=!0,r.extend=n.extend,r.create=n.create,r},n.create=function(t){var e,n,i,r=_.toArray(arguments),s=this.extend(t),o="return new child(",a=["child"],c=[s];if(r.shift(),e=r.length,e>0){for(n=0;e>n;n++)o+="arg"+n+", ",a.push("arg"+n),c.push(r[n]);o=o.substr(0,o.length-2)}o+=");",a.push(o);try{i=Function.apply(void 0,a).apply(void 0,c)}catch(u){throw u}return i},t.Class=n})(this),function(t){"use strict";Array.prototype.indexOf||(Array.prototype.indexOf=function(t,e){return _.indexOf(this,t,e)});var e=/\s+/,n=".",i=function(t,e,i,r){var s=t.split(n);return{c:i,s:r,fn:e,n:s[0],ns:s.slice(1)}},r=function(t,e){var n,i=!(t.fn&&t.fn!==e.fn||t.n&&t.n!==e.n||t.c&&t.c!==e.c);return i&&t.ns.length&&(n=e.ns,i=!_.any(t.ns,function(t){return n.indexOf(t)})),i},s=function(t,e,n,s,o){var a,c,u,h,l="any"===o?!1:[],f=i(e,n,s);if(o||(o="filter"),!t[f.n])return l;for(a=t[f.n],u=0,c=a.length;c>u;u++)if(h=a[u],r(f,h))if("filter"===o)l.push(h);else if("any"===o){l=!0;break}return l},o=function(t,e,n,s){var o,a;if(t._listeners){if(!e&&!n&&!s)return delete t._listeners,void 0;if(o=i(e,n,s),!o.ns.length&&!n&&!s)return delete t._listeners[o.n],void 0;if(!o.n||t._listeners[o.n]){var c={};o.n?c[o.n]=t._listeners[o.n]:c=t._listeners,_.each(c,function(t){for(a=0;t.length>a;a++)r(o,t[a])&&(t.splice(a,1),a--)})}}},a=Class.extend({on:function(t,n,r,s){var o,a,c,u,h,l,f,d,p=this;if(_.isObject(t)){o=n||p;for(h in t)p.on(h,t[h],o,s);return this}if("function"!=typeof n)throw TypeError("function expected");for(r||(r=this),a=t.split(e),c=0,u=a.length;u>c;c++)l=i(a[c],n,r,s),f=p._listeners||{},d=f[l.n]||[],d.push(l),f[l.n]=d,p._listeners=f;return p},off:function(t,n,i){var r,s,a,c=this;if(!t)return o(c,"",n,i),c;for(a=t.split(e),r=0,s=a.length;s>r;r++)o(c,a[r],n,i);return c},fire:function(t){if(!this._listeners)return this;var n,s,o,a,c,u,h,l=_.rest(arguments,1),f=this;for(o=t.split(e),n=0,s=o.length;s>n;n++){if(a=i(o[n],!1,!1),!a.n)throw"not implemented";if(c=f._listeners[a.n],!c)return f;for(u=0;c.length>u;u++)h=c[u],r(a,h)&&(h.s&&(c.splice(u,1),u--),h.fn.apply(h.c,l))}return f},one:function(t,e,n){return this.on(t,e,n,!0)},hasListener:function(t){return this._listeners?s(this._listeners,t,!1,!1,"any"):!1}});a.prototype.trigger=a.prototype.fire,t.Events=a}(this),function(t){"use strict";var e={},n=Events.extend({reverseComputedDeps:{},setComputeds:function(t){var e=this;_.each(t,function(t){var n=e._computeds[t].get();e.fire("change:"+t,n)})},addComputed:function(t,e){e.name=t,e.model=this,this._computeds[t]=new n.Computed(e)},removeComputed:function(t){var e=this;delete e._computeds[t],_.each(e.reverseComputedDeps,function(n,i){e.reverseComputedDeps[i]=_.without(n,t)})},constructor:function(t){var n=this;t=t||{},n.attributes=_.extend({},n.defaults,n.parse(t)),this.reverseComputedDeps={},this._computeds={},_.each(n.computeds,function(t,e){n.addComputed(e,t)}),n.useDefineProperty&&_.each(n.serialize(),function(t,e){Object.defineProperty(n,e,{get:function(){return this.prop(e)},set:function(t){this.prop(e,t)}})}),n._changed={},n.id=n.attributes[n.idAttribute],n.cid=_.uniqueId("c"),n.mapping&&n.id&&(e[n.mapping]=e[n.mapping]||{},e[n.mapping][n.id]=n),n.initialize()},initialize:function(){return this},idAttribute:"id",mapping:!1,useDefineProperty:!1,computeds:{},_computeds:{},defaults:{},serialize:function(){return _.extend({},this.attributes,_.mapValues(this._computeds,function(t){return t.value}))},toJSON:function(){return this.serialize()},parse:function(t){return t},baseURL:"/",url:function(){return this.baseURL+(this.mapping?this.mapping+"/":"")+(this.id?this.id+"/":"")},update:function(t){return this.prop(this.parse(t)),this._changed={},this},prop:function(t,e){var n,i=this;if(1===arguments.length&&"string"==typeof t)return(n=i._computeds[t])?n.value:i.attributes[t];var r={},s={};return"string"==typeof t?r[t]=e:r=t,_.each(r,function(t,e){s[e]=i._changed[e]=t,(n=i._computeds[e])?n.set(t):i.attributes[e]=t,i.reverseComputedDeps[e]&&i.setComputeds(i.reverseComputedDeps[e]),e===i.idAttribute&&(i.id=t),i.fire("change:"+e,t)}),this.fire("change",s),this},validate:function(){return!1},fetch:function(t){t=t||{};var e=this,i={success:function(n){e.update(n),"function"==typeof t.success&&t.success.apply(e,arguments)},error:function(){"function"==typeof t.error&&t.error.apply(e,arguments)}};return n.sync("get",this.url(),_.extend({},t,i)),this},save:function(t){var e,i=this,r=this.validate(t);if(r)return this.trigger("invalid",this,r),void 0;if(e=_.isFunction(this.url)?this.url():this.url,t&&this.prop(t),this.id){if(0===_.keys(i._changed).length)return this;n.sync("update",e,{data:i._changed,success:function(t){i.update(t)}})}else n.sync("create",e,{data:_.clone(this.attributes),success:function(t){i.update(t)}});return this},remove:function(){this.fire("remove"),this.id&&n.sync("delete",this.url(),{})}});n.fromStorage=function(t,n){return e[t]=e[t]||{},e[t][n]},n.createOrUpdate=function(t,e){var i,r,s,o=t.prototype;return o.mapping&&(r=o.idAttribute,s=o.parse(e),i=n.fromStorage(o.mapping,s[r]))?(i.update(e),i):new t(e)},n.sync=function(t,e,n){n=n||{};var i={method:t};"PUT"===t&&(t="POST"),$.extend(i,n.data),$.ajax({url:e,dataType:"json",type:t,data:i,success:n.success,error:n.error})},n.filters={};var i=/\s*\|\s*/,r=/(\w+)(\s*:\s*['"]([^'"]+)['"])?/;n.hasFilters=function(t){return-1!=t.indexOf("|")},n.parseFilters=function(t){var e=t.split(i),n=e.shift();return{value:n,filters:_.foldl(e,function(t,e){var n=r.exec(e),i=n[3],s=n[1];return t[s]=i,t},{})}},n.Computed=Class.extend({constructor:function(t){this.deps=t.deps||[],this.name=t.name,this.model=t.model,this.filters=t.filters||{},t.filtersString&&this.parseFilters(t.filtersString),t.get&&(this.getter=t.get),t.set&&(this.setter=t.set),this.get();var e=this.model.reverseComputedDeps;_.each(this.deps,function(n){e[n]||(e[n]=[]),e[n].push(t.name)})},value:void 0,deps:[],model:void 0,filters:{},getter:function(t){return t},setter:function(t,e){this.prop(e,t)},parseFilters:function(t){var e=n.parseFilters(t);this.deps=[e.value],this.filters=e.filters},get:function(){var t=this,e=_.foldl(t.deps,function(e,n){return e.push(t.model.prop(n)),e},[]),i=t.getter.apply(t,e);return t.value=_.foldl(this.filters,function(t,e,i){return n.filters[i].format(t,e)},i),t.value},set:function(t){this.setter.call(this.model,_.foldl(this.filters,function(t,e,i){return n.filters[i].unformat(t,e)},t),this.name),this.get()}}),t.Model=n}(this),function(t){"use strict";var e=function(t){this.self=t},n=Model.extend({constructor:function(t,n){this.attributes={},this._changed={},this.itself=new e(this),this.models=[],this.length=0,t&&this.reset(t),this.initialize(n)},models:[],model:Model,url:function(){return this.baseURL+this.model.prototype.mapping+"/"},fetch:function(t){t=t||{};var e=this,n={success:function(n){e.reset(n,t),"function"==typeof t.success&&t.success.apply(e,arguments)},error:function(){"function"==typeof t.error&&t.error.apply(e,arguments)}},i=_.extend({},t,n);Model.sync("GET",this.url(),i)},reset:function(t,e){if(e=e||{},e.add||(this.fire("cut",this.models),this.models=[],this.length=0),!t)return this.fire("reset"),this;var n=this.parse(t);return this.add(n,"end"),e.add||this.fire("reset"),this},push:function(t){return this.add(t)},unshift:function(t){return this.add(t,0)},add:function(t,e,n){var i=this,r=[];return t instanceof Array||(t=[t]),"number"!=typeof e&&(e=this.length),_.each(t,function(t,n){t instanceof Model||(t=Model.createOrUpdate(i.model,t)),r.push(t),t.one("remove",function(){i.cutByCid(this.cid)}),i.models.splice(e+n,0,t)}),this.length=this.models.length,n||this.fire("add",r,e),this},cut:function(t){var e,n=this;return this.each(function(i,r){return i.id===t?(e=n.cutAt(r),!1):void 0}),e},cutByCid:function(t){var e,n=this;return this.each(function(i,r){return i.cid===t?(e=n.cutAt(r),!1):void 0}),e},shift:function(){return this.cutAt(0)},pop:function(){return this.cutAt()},cutAt:function(t){void 0===t&&(t=this.models.length-1);var e,n=this.models.splice(t,1)[0];return this.length=this.models.length,e={},e[t]=n,this.fire("cut",e),n},at:function(t){return this.models[t]},get:function(){return this.getByID.apply(this,arguments)},getByID:function(t){var e;return this.each(function(n){return n.id==t?(e=n,!1):void 0}),e},getByCid:function(t){var e;return this.each(function(n){return n.cid==t?(e=n,!1):void 0}),e}}),i=["detect","filter","select","reject","find","every","all","some","any","max","min","sortBy","sortByDesc","first","initial","rest","last","groupBy"],r=["forEach","each","map","reduce","reduceRight","foldl","foldr","include","contains","invoke","sortedIndex","toArray","size","without","indexOf","shuffle","lastIndexOf","isEmpty"],s=["filter","reject"],o=["sortBy","sortByDesc","shuffle"];_.mixin({sortByDesc:function(t,e,n){return this.sortBy(t,e,n).reverse()}});var a=function(t){return function(e){var n=!0;return _.forIn(t,function(t,i){return t!==e.attributes[i]?(n=!1,!1):void 0}),n}},c=function(t){return function(e){return e.attributes[t]}};_.each(r,function(t){n.prototype[t]=function(){return _[t].apply(_,[this.models].concat(_.toArray(arguments)))}}),_.each(i,function(t){n.prototype[t]=function(e,n){if("function"==typeof e)return _[t].apply(_,[this.models].concat(_.toArray(arguments)));var i;if("string"==typeof e){if(2!=arguments.length)return _[t](this.models,c(e));i={},i[e]=n}return i||(i=e),_[t](this.models,a(i))}}),_.each(s,function(t){e.prototype[t]=function(){var e="filter"===t?"reject":"filter",n=this.self,i=(_.toArray(arguments),n[t].apply(n,arguments)),r=n[e].apply(n,arguments),s={};return _.each(r,function(t){s[n.indexOf(t)]=t}),n.models=i,n.length=i.length,n.fire("cut",s),n}}),_.each(o,function(t){e.prototype[t]=function(){var e=this.self,n=e[t].apply(e,arguments),i={};return _.each(n,function(t,n){i[n]=e.indexOf(t)}),e.models=n,e.length=n.length,e.fire("sort",i),e}}),t.Collection=n}(this),function(t){"use strict";var e,n=t.$,i=/\s+/,r=/^[a-z]+$/,s=/^\s*([^:]+)\s*:\s*([\s\S]*\S)\s*$/,o=/\s*,\s*/,a={shortcuts:{},setElement:function(t){return this.undelegateEvents(),this.el=t,this.$el=n(t),this.parseBinds().delegateEvents(),this},constructor:function(t){t=t||{},this.options=t,t.collection&&(this.collection=t.collection),this.model=t.model,t.el&&(this.el=t.el);var e=this;e._cid||(e._cid=_.uniqueId("vm")),e.el||(e.el="div"),"string"==typeof e.el&&(e.el=r.test(e.el)&&"html"!==e.el&&"body"!==e.el?document.createElement(e.el):n(e.el)[0]),e.$el=n(e.el),e.$=function(t){return e.$el.find(t)},_.each(e.shortcuts,function(t,n){e[n]=e.$(t)}),this._super(),e.autoParseBinds&&e.parseBinds(),e.delegateEvents()},remove:function(){return this.$el.remove(),this},parseBinds:function(){return a.findBinds(this.el,this),this},autoParseBinds:!1,initialize:function(){},delegateEvents:function(t){t=t||this.events,this.undelegateEvents();var e,n,r=this;return _.each(t,function(t,s){var o,a="function"==typeof t?t:r[t];if("function"!=typeof a)throw TypeError(t+" is not a function");e=s.split(i),n=e.shift().split(",").join("."+r._cid+" ")+"."+r._cid,o=_.bind(a,r),e.length?r.$el.delegate(e.join(" "),n,o):r.$el.bind(n,o)}),this},undelegateEvents:function(){return this.$el.unbind("."+this._cid),this},render:function(){return this}};a=Model.extend(a),a.findBinds=function(t,e){var i,r,s=!1,o=this,a=n(t),c=a[0];if(!c)throw Error("Element not exists");return(r=o.tags[c.tagName.toLowerCase()])?(r.call(o,a,e),void 0):(_.forIn(_.foldl(c.attributes,function(t,e){return t[e.nodeName]=e.nodeValue,t},{}),function(t,n){var r=o.customAttributes[n];r&&(i=r.call(o,a,t,e),i===!1?s=!0:i&&(e=i))}),s||a.contents().each(function(){var t=this;3==this.nodeType?_.forIn(o.inlineModificators,function(n){n.call(o,t,e)}):1==this.nodeType&&o.findBinds(t,e)}),void 0)},e=function(t){var e={};return _.each(t.split(o),function(t){var n=s.exec(t);n&&(e[n[1]]=n[2])}),e},a.parseOptionsObject=function(t){var n,i={},r=0,s=function(t){t.match(/\{[^{}]*\}/)&&s(t.replace(/\{[^{}]*\}/,function(t){var n=Math.random()+r++;return i[n]=e(t.slice(1,-1)),n}))};if(s(t),_.each(i,function(t){_.each(t,function(e,n){i[e]&&(t[n]=i[e],delete i[e])})}),_.each(i,function(t){n=t}),!n)throw Error(t+" is not valid options object");return n},t.ViewModel=a}(this),function(){"use strict";var t=function(t){return t||(0===t?"0":"")};ViewModel.replaceable=function(t,e,n){var i,r=function(t){i&&(i.off("replace",r),n(i)),e(t),t.on("replace",r),i=t};r(t)},ViewModel.applyFilters=function(t,e,n,i){var r;return ViewModel.replaceable(e,function(e){Model.hasFilters(t)?(r=_.uniqueId("vmDynamicComputed"),e.addComputed(r,{filtersString:t})):r=t,e.on("change:"+r,n),n(e.prop(r))},function(e){Model.hasFilters(t)&&e.removeComputed(r),e.off("change:"+r,n),i&&i(e.prop(r))}),r},ViewModel.binds={log:function(t,e,n){this.applyFilters(e,n,function(t){console.log(n,".",e,"=",t)})},src:function(t,e,n,i){var r=t[0];this.findCallAndSubscribe(e,n,i,function(t){r.src=t||""},t)},html:function(e,n,i){this.applyFilters(n,i,function(n){e.html(t(n))})},text:function(e,n,i){this.applyFilters(n,i,function(n){e.text(t(n))})},value:function(e,n,i){var r=this.applyFilters(n,i,function(n){e.val(t(n))});e.on("change keyup keydown",function(){var t=e.val();i.prop(r,t)})},attr:function(t,e,n){var i=t[0];_.each(this.parseOptionsObject(e),function(t,e){ViewModel.applyFilters(t,n,function(t){t!==!1&&void 0!==t&&null!==t?i.setAttribute(e,t):i.removeAttribute(e)})})},style:function(t,e,n){_.each(this.parseOptionsObject(e),function(e,i){ViewModel.applyFilters(e,n,function(e){t.css(i,e)})})},css:function(t,e,n){_.each(this.parseOptionsObject(e),function(e,i){ViewModel.applyFilters(e,n,function(e){e?t.addClass(i):t.removeClass(i)})})},display:function(t,e,n){ViewModel.applyFilters(e,n,function(e){e?t.show():t.hide()})},click:function(t,e,n,i){var r=this.evil(e,n,i,t)();t.click(function(){r.apply(n,arguments)})},className:function(t,e,n){var i;ViewModel.applyFilters(e,n,function(e){i&&t.removeClass(i),e&&t.addClass(e),i=e})},events:function(t,e,n,i){var r=this;_.each(this.parseOptionsObject(e),function(e,s){var o=r.evil(e,n,i)();t.bind(s,function(t){o.call(n,t)})})},view:function(t,e,n,i){var r,s,o,a,c;try{r=this.parseOptionsObject(e)}catch(u){c=e.split(/\s*,\s*/),r={"class":c[0],name:c[1]}}return s=r["class"]?this.evil(r["class"],n,i)():ViewModel.extend({autoParseBinds:!0}),o={el:t},r.options&&_.forOwn(r.options,function(t,e){o[e]=ViewModel.evil(t,n,i)()}),a=new s(o),r.name&&(n[r.name]=a),!1},$click:function(t,e,n,i){return t.click(this.evil(e,n,i)),!1}};var e=/\s*;\s*/,n=/^\s*([^:]+)\s*:\s*([\s\S]*\S)\s*$/,i=/\s*,\s*/,r=function(t,r,s,o,a){r.removeAttr(t);var c,u;return s&&_.each(s.split(e),function(t){var e,s,h,l=t.match(n);l?(e=l[1],s=l[2]):(e=t,s=""),e=e.split(i),_.each(e,function(t){t&&"!"!==t.charAt(0)&&(h=ViewModel.binds[t],h?(c=h.call(ViewModel,r,s,o,a),c===!1?u=!0:c&&(o=c)):console.warn('Bind: "'+t+'" not exists'))})}),u?!1:o};ViewModel.tag=function(t,e){document.createElement(t),ViewModel.tags[t]=e},ViewModel.removeTag=function(t){delete ViewModel.tags[t]},ViewModel.tags={},ViewModel.customAttributes={"data-bind":function(t,e,n,i){return r("data-bind",t,e,n,i)},nk:function(t,e,n,i){return r("nk",t,e,n,i)}},Model.filters._sysEmpty={format:t},ViewModel.inlineModificators={"{{}}":function(t,e){var n,i,r,s=t.nodeValue,o=[t],a=ViewModel.inlineModificators["{{}}"].regex;if(a.lastIndex=0,a.test(s)){var c=s.split(a),u=[],h="return ";_.each(c,function(t,e){if(e%2){t+=" | _sysEmpty";var n=Model.parseFilters(t);t=_.foldl(n.filters,function(t,e,n){var i="";return void 0!==e&&(i=', "'+e+'"'),"Model.filters."+n+".format("+t+i+")"},n.value),u.push(n.value),h+=t+"+"}else h+='"'+t+'"+'}),h+='"";',h=h.replace(/\n/g,"\\n\\\n"),n=t.parentNode,r=document.createElement("div");var l,f=1===n.childNodes.length?function(t){try{n.innerHTML=t}catch(e){console.log(e)}}:function(t){i=document.createDocumentFragment();try{r.innerHTML=t}catch(e){console.log(e)}var s,a=_.toArray(r.childNodes);for(s=o[0];o[1];)n.removeChild(o[1]),o.splice(1,1);if(!a.length)return s.nodeValue="",o=[s],void 0;for(;r.childNodes[0];)i.appendChild(r.childNodes[0]);if(i.childNodes.length)try{n.insertBefore(i,s)}catch(c){throw c}n.removeChild(s),o=a};ViewModel.replaceable(e,function(t){l=_.uniqueId("vmDynamicComputed");try{var e=Function(u.join(","),h)}catch(n){console.log(n),console.log(h)}t.addComputed(l,{deps:u,get:e}),t.on("change:"+l,f),f(t.prop(l))},function(t){t.removeComputed(l),t.off("change:"+l,f)})}}},ViewModel.inlineModificators["{{}}"].regex=/\{\{([\s\S]+?)\}\}/g}(),function(){"use strict";var t={},e={};ViewModel.tmpl={setRawTemplate:function(e,n){t[e]=n},getRawTemplate:function(e){return t[e]},get:function(n,i){var r,s=e[n];if(!s){if(r=t[n],void 0===r)throw Error('Raw template: "'+n+'" is not defined');e[n]=s=i(r)}return s}},ViewModel.binds.template=function(n,i,r,s){var o=$(n),a=i.split(/\s*,\s*/),c=a[0],u=a[1];return t[c]=o.html(),o.remove(),u&&(u=this.evil(u,r,s),e[c]=u(t[c])),!1}}(),function(){"use strict";ViewModel.binds.withModel=function(t,e,n){var i;return this.applyFilters(e,n,function(t){i&&i.fire("replace",t),i=t}),i};var t={},e=function(t){return!1};setInterval(function(){_.each(t,function(e,n){_.each(e,function(t){t.clearBinds(),t.data("nkModel","")}),t[n]=[]})},3e5),ViewModel.binds.eachModel=function(n,i,r){var s,o,a,c,u,h=n[0],l={},f=h.tagName.toLowerCase();return s=i.split(/\s*,\s*/),o=s[0],a=s[1],c=a?"":n.html(),u=a?a:_.uniqueId("nkEachModelTemplate"),t[u]=[],this.applyFilters(o,r,function(i){n.empty();var r,s,o;if(i){r=1,s=function(t){var n=$(t);return function(t,i){var s=e(u,t,i);return s||(s=n.clone(),s.each(function(){ViewModel.findBinds(this,t)})),r=s.length,s}},o=a?ViewModel.tmpl.get(a,s):s(c);var h=$(document.createElement(f)),d=0;n.empty(),i.each(function(t){h.append(o(t,d++,i))}),n.append(h.children()),i.on("add",function(t,e,s){var a=0,c="",u=s||e;c=$(document.createElement(f)),_.each(t,function(t){c.append(o(t,u+a++,i))}),c=c.children(),0===e?n.prepend(c):e&&e!==i.length-t.length?n.children().eq(e*r).before(c):n.append(c)},l),i.on("cut",function(e){var i,s,o,a=n.children();for(i in e)i*=1,s=e[i],s.off(0,0,l),o=a.slice(i,i+r),t[u].push(o),o.detach()},l),i.on("sort",function(t){var e=$(document.createElement(f)),i=n.children();_.each(t,function(t){e.append(i.slice(t,t+r))}),n.append(e.children())},l)}},function(t){t.off(0,0,l),t.each(function(t){t.off(0,0,l)})}),!1}}(),function(t){"use strict";var e=/\((.*?)\)/g,n=/(\(\?)?:\w+/g,i=/\*\w+/g,r=/[\-{}\[\]+?.,\\\^$|#\s]/g;t.Router=Events.extend({constructor:function(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},initialize:function(){},route:function(e,n,i){_.isRegExp(e)||(e=this._routeToRegExp(e)),_.isFunction(n)&&(i=n,n=""),i||(i=this[n]);var r=this;return t.History.route(e,function(s){var o=r._extractParameters(e,s);i&&i.apply(r,o),r.trigger.apply(r,["route:"+n].concat(o)),r.trigger("route",n,o),t.History.trigger("route",r,n,o)}),this},navigate:function(e,n){return t.History.navigate(e,n),this},_bindRoutes:function(){if(this.routes){this.routes=_.result(this,"routes");for(var t,e=_.keys(this.routes);null!=(t=e.pop());)this.route(t,this.routes[t])}},_routeToRegExp:function(t){return t=t.replace(r,"\\$&").replace(e,"(?:$1)?").replace(n,function(t,e){return e?t:"([^/]+)"}).replace(i,"(.*?)"),RegExp("^"+t+"$")},_extractParameters:function(t,e){var n=t.exec(e).slice(1);return _.map(n,function(t){return t?decodeURIComponent(t):null})}})}(this),function(t){"use strict";var e=/^[#\/]|\s+$/g,n=/^\/+|\/+$/g,i=/msie [\w.]+/,r=/\/$/,s=Events.extend({interval:50,started:!1,constructor:function(){this.handlers=[],_.bindAll(this,"checkUrl"),t!==void 0&&(this.location=t.location,this.history=t.history)},getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(t,n){if(null==t)if(this._hasPushState||!this._wantsHashChange||n){t=this.location.pathname;var i=this.root.replace(r,"");t.indexOf(i)||(t=t.slice(i.length))}else t=this.getHash();return t.replace(e,"")},start:function(r){if(this.started)throw Error("Backbone.history has already been started");this.started=!0,this.options=_.extend({},{root:"/"},this.options,r),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var s=this.getFragment(),o=document.documentMode,a=i.exec(navigator.userAgent.toLowerCase())&&(!o||7>=o);this.root=("/"+this.root+"/").replace(n,"/"),a&&this._wantsHashChange&&(this.iframe=$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(s)),this._hasPushState?$(t).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in t&&!a?$(t).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=s;var c=this.location,u=c.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!u)return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0;this._hasPushState&&u&&c.hash&&(this.fragment=this.getHash().replace(e,""),this.history.replaceState({},document.title,this.root+this.fragment+c.search))}return this.options.silent?void 0:this.loadUrl()},stop:function(){$(t).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),this.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(){var t=this.getFragment();return t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t===this.fragment?!1:(this.iframe&&this.navigate(t),this.loadUrl(),void 0)},loadUrl:function(t){var e=this.fragment=this.getFragment(t);return _.any(this.handlers,function(t){return t.route.test(e)?(t.callback(e),!0):void 0})},navigate:function(t,e){if(!this.started)return!1;if(e&&e!==!0||(e={trigger:!!e}),t=this.getFragment(t||""),this.fragment!==t){this.fragment=t;var n=this.root+t;if(""===t&&"/"!==n&&(n=n.slice(0,-1)),this._hasPushState)this.history[e.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,t,e.replace))}return e.trigger?this.loadUrl(t):void 0}},_updateHash:function(t,e,n){if(n){var i=t.href.replace(/(javascript:|#).*$/,"");t.replace(i+"#"+e)}else t.hash="#"+e}});t.History=new s}(this);